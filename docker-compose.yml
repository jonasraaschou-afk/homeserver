version: '3.8'

services:
  # PostgreSQL Database - Delt database for n8n og NocoDB
  postgres:
    image: postgres:15-alpine
    container_name: homeserver-postgres
    restart: unless-stopped
    environment:
      - POSTGRES_USER=${POSTGRES_USER:-postgres}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD}
      - POSTGRES_DB=${POSTGRES_DB:-homeserver}
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./init-db.sql:/docker-entrypoint-initdb.d/init-db.sql:ro
    networks:
      - homeserver-network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-postgres}"]
      interval: 10s
      timeout: 5s
      retries: 5

  # n8n - Workflow Automation
  n8n:
    image: n8nio/n8n:latest
    container_name: homeserver-n8n
    restart: unless-stopped
    ports:
      - "${N8N_PORT:-5678}:5678"
    environment:
      - DB_TYPE=postgresdb
      - DB_POSTGRESDB_HOST=postgres
      - DB_POSTGRESDB_PORT=5432
      - DB_POSTGRESDB_DATABASE=${N8N_DB:-n8n}
      - DB_POSTGRESDB_USER=${POSTGRES_USER:-postgres}
      - DB_POSTGRESDB_PASSWORD=${POSTGRES_PASSWORD}
      - N8N_BASIC_AUTH_ACTIVE=true
      - N8N_BASIC_AUTH_USER=${N8N_BASIC_AUTH_USER}
      - N8N_BASIC_AUTH_PASSWORD=${N8N_BASIC_AUTH_PASSWORD}
      - N8N_HOST=${N8N_HOST:-localhost}
      - N8N_PORT=5678
      - N8N_PROTOCOL=${N8N_PROTOCOL:-http}
      - WEBHOOK_URL=${N8N_WEBHOOK_URL:-http://localhost:5678/}
      - GENERIC_TIMEZONE=${TIMEZONE:-Europe/Copenhagen}
    volumes:
      - n8n_data:/home/node/.n8n
    networks:
      - homeserver-network
    depends_on:
      postgres:
        condition: service_healthy

  # NocoDB - No-Code Database Platform
  nocodb:
    image: nocodb/nocodb:latest
    container_name: homeserver-nocodb
    restart: unless-stopped
    ports:
      - "${NOCODB_PORT:-8080}:8080"
    environment:
      - NC_DB=pg://postgres:5432?u=${POSTGRES_USER:-postgres}&p=${POSTGRES_PASSWORD}&d=${NOCODB_DB:-nocodb}
      - NC_AUTH_JWT_SECRET=${NOCODB_JWT_SECRET}
      - NC_PUBLIC_URL=${NOCODB_PUBLIC_URL:-http://localhost:8080}
      - NC_DISABLE_TELE=true
    volumes:
      - nocodb_data:/usr/app/data
    networks:
      - homeserver-network
    depends_on:
      postgres:
        condition: service_healthy

  # Nextcloud - Cloud Storage og Collaboration
  nextcloud:
    image: nextcloud:latest
    container_name: homeserver-nextcloud
    restart: unless-stopped
    ports:
      - "${NEXTCLOUD_PORT:-8081}:80"
    environment:
      - POSTGRES_HOST=postgres
      - POSTGRES_DB=${NEXTCLOUD_DB:-nextcloud}
      - POSTGRES_USER=${POSTGRES_USER:-postgres}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD}
      - NEXTCLOUD_ADMIN_USER=${NEXTCLOUD_ADMIN_USER:-admin}
      - NEXTCLOUD_ADMIN_PASSWORD=${NEXTCLOUD_ADMIN_PASSWORD}
      - NEXTCLOUD_TRUSTED_DOMAINS=${NEXTCLOUD_TRUSTED_DOMAINS:-localhost}
      - OVERWRITEPROTOCOL=${NEXTCLOUD_PROTOCOL:-http}
    volumes:
      - nextcloud_data:/var/www/html
      - nextcloud_apps:/var/www/html/custom_apps
      - nextcloud_config:/var/www/html/config
      - nextcloud_data_files:/var/www/html/data
    networks:
      - homeserver-network
    depends_on:
      postgres:
        condition: service_healthy

  # Dashboard - Landing page til alle services
  dashboard:
    image: nginx:alpine
    container_name: homeserver-dashboard
    restart: unless-stopped
    ports:
      - "${DASHBOARD_PORT:-8082}:80"
    volumes:
      - ./dashboard:/usr/share/nginx/html:ro
      - ./dashboard/nginx.conf:/etc/nginx/conf.d/default.conf:ro
    networks:
      - homeserver-network

  # Portainer - Docker Management UI
  portainer:
    image: portainer/portainer-ce:latest
    container_name: homeserver-portainer
    restart: unless-stopped
    ports:
      - "${PORTAINER_PORT:-9000}:9000"
      - "${PORTAINER_EDGE_PORT:-8000}:8000"
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - portainer_data:/data
    networks:
      - homeserver-network
    security_opt:
      - no-new-privileges:true

  # Spree Commerce - E-commerce Platform
  spree:
    image: registry.gitlab.com/spree/spree:latest
    container_name: homeserver-spree
    restart: unless-stopped
    ports:
      - "${SPREE_PORT:-3000}:3000"
    environment:
      - DB_ADAPTER=postgresql
      - DB_HOST=postgres
      - DB_PORT=5432
      - DB_NAME=${SPREE_DB:-spree}
      - DB_USERNAME=${POSTGRES_USER:-postgres}
      - DB_PASSWORD=${POSTGRES_PASSWORD}
      - RAILS_ENV=development
      - RAILS_SERVE_STATIC_FILES=true
      - RAILS_LOG_TO_STDOUT=true
    volumes:
      - spree_data:/app/public/spree
    networks:
      - homeserver-network
    depends_on:
      postgres:
        condition: service_healthy
    command: ["bash", "-c", "bundle exec rails db:create db:migrate db:seed && bundle exec rails server -b 0.0.0.0 -p 3000"]

  # Cloudflare Tunnel - Sikker adgang til internettet
  cloudflared:
    image: cloudflare/cloudflared:latest
    container_name: homeserver-cloudflared
    restart: unless-stopped
    command: tunnel run
    environment:
      - TUNNEL_TOKEN=${CLOUDFLARE_TUNNEL_TOKEN}
    networks:
      - homeserver-network
    depends_on:
      - n8n
      - nocodb
      - nextcloud
      - dashboard
      - portainer
      - spree

networks:
  homeserver-network:
    driver: bridge

volumes:
  postgres_data:
    driver: local
  n8n_data:
    driver: local
  nocodb_data:
    driver: local
  nextcloud_data:
    driver: local
  nextcloud_apps:
    driver: local
  nextcloud_config:
    driver: local
  nextcloud_data_files:
    driver: local
  portainer_data:
    driver: local
  spree_data:
    driver: local
